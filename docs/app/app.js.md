wq/app.js
======

[wq/app.js]

**wq/app.js** is a [wq.app] module that provides a configuration-driven JavaScript application controller to facilitate the creation of complete mobile web apps for viewing and submitting field data.   wq/app.js is primarily intended for use as a client for [wq.db]'s [app.py], but can be used with any REST service with the same [URL structure].

## Overview

wq/app.js is the highest-level wq.app module, and brings together a number of lower-level modules and wq conventions into an integrated API.  As a primarily configuration-driven module, wq/app.js is relatively easy to use, but enforces a number of constraints on the design of your project.  In particular, it works best with [wq.db.rest] or a compatible REST service.  Depending on your project needs, it may be better to forego wq/app.js and directly utilize the underlying APIs in [wq/store.js] and [wq/pages.js].  The documentation for these modules is also useful as a background to this module.

The specific concepts leveraged by wq/app.js include:

 * A specific [URL structure] that is observed by both the application itself and its REST API.
 * A client-side URL router and page renderer (provided by [wq/pages.js]) that can fall back to server-rendered pages via [shared client/server templates].
 * A model-driven, `localStorage`-backed cache of REST API responses (provided by [wq/store.js]).
 *  A [wq configuration object] generated by the URL router on the server, that describes the available routes (and underlying models).
 * An optional [authentication] endpoint provided by the REST API, including CSRF tokens to prevent cross-site attacks.

## Configuration

In a simple project, the only required usage of wq/app.js is to initialize it:

```javascript
app.init(config, templates, [baseurl], [svcurl]);
```

`app.init()` accepts up to four arguments:

name | purpose
-----|---------
`config` | a wq/app.js configuration object (described below)
`templates` | a collection of [Mustache templates] for use in [client-side rendering]
`baseurl` | (optional) path used to prefix application URLs to help with route matching in [wq/pages.js].  `baseurl` should be set to the base url of your application (without the trailing `/`) if your application is not running at the root of your domain.
`svcurl` | (optional) path or fully-qualified URL used to prefix REST API requests in [wq/store.js].  It should only need to be set be if your REST service is not running at the same base url as your application.  For best results, the application and the REST service should be running at the same URL (see "[My website is its own REST API]").

### wq/app.js Configuration Object

The wq/app.js configuration object is an extension of the [wq configuration object] with an additional three sections.

```javascript
{
    'pages': { /* ... */ },
    'defaults': { /* ... */ },
    'transitions': { /* ... */ },
    'store': { /* ... */ }
}
```

A wq.db-compatible REST service will automatically provide a `pages` configuration that can be utilized by wq/app.js.  The remaining configuration options (`defaults`, `transitions`, and `store`) need to be configured manually.

#### `pages`: URL routes

The `pages` configuration section is typically generated by the REST service and describes the URL routes in the application.  The full list of options is described in the documentation for the [wq configuration object].

> **Note**: If you need to customize an option in the server generated `pages`, you should specify it when calling [app.router.register_model] in [wq.db.rest] rather than overriding the `pages` section in your `config.js`.  This ensures that the client and the server are on the same "page".

#### `defaults`: Template Context Variables

The `defaults` configuration section is used to set default values that will be available in every [template rendering context].  The keys are the name of the context variables to use, and the values can be simple strings or functions.  For example, to define variable `{{year}}` that is available in every template, you could do the following:

```javascript
config.defaults = {
    'year': function() {
        return new Date().getFullYear();
    }
};
```

Note that setting a context variable in JavaScript will have no effect for templates rendered by the server.  To achieve consistent template rendering with wq.db, you can use Django's [template context processors].  An equivalent context processor for the above would be:

```python
# myapp/context_processors.py
from datetime import date
def year(request):
    return {
        'year': date.today().year
    }
```

#### `transitions`: Page Transitions

Configuration for jQuery Mobile's built in [page transitions].  Where applicable, this information is mapped to jQuery Mobile's built-in configuration options.

 Name | Usage
------|-------
`default` | A shortcut for [$.mobile.defaultPageTransition].  Often set to `slide`.
`dialog` | A shortcut for [$.mobile.defaultDialogTransition].
`save` | Sets the default transition to use when moving from an edit view back to a detail view after a save.  This is often set to `flip`.
`maxwidth` | A shortcut for [$.mobile.maxTransitionWidth].  Defaults to 800 (note that vanilla jQuery Mobile defaults to false),

#### `store`: wq/store.js configuration

Configuration options for [wq/store.js].  These options will be passed on as the third argument to `ds.init()`.  See the documentation for [wq/store.js] for the complete list of options.

#### Creating a Configuration Module

The configuration object can be defined as a variable in the same file as the call to `app.init()`.  However, the conventional approach is to create a separate AMD module `js/myapp/config.js` that depends on the server-created config and then adds the additional attributes:

```javascript
define(['db/config', function(config) {
// config.pages already exists on server-generated config

config.defaults = {
// Configure default template context variables
};
config.transitions = {
// Configure default jQuery Mobile page transitions
}
config.store = {
// Configure wq/store.js
}
return config;
});
```

If you are not utilizing the wq.db-generated configuration, you can define the entire configuration object in config.js:

```javascript
define({
    'pages': { /* ... */ },
    'defaults': { /* ... */ },
    'transitions': { /* ... */ },
    'store': { /* ... */ }
});
```

### Inlining Templates
The `templates` can be created as regular Mustache HTML files and then inlined into a JavaScript object through the [collectjson] step in the [wq build process].  The resulting object should be of the form:

```javascript
{
     '[modelname]_list': "<html>...</html>",
     '[modelname]_detail': "<html>...</html>",
     '[modelname]_edit': "<html>...</html>",
     // so on for each model...
     
     '[staticpage]': "<html>...</html>",
     'partials': {
          'head': "..."
     }
}
```
By convention, this object is typically wrapped in an AMD `define()` and placed in the file `js/myapp/templates.js`.

### Putting all Together

`app.init()` should typically be called immediately when the JavaScript loads.  Assuming `template.js` and `config.js` are created as above, this can be accomplished by creating a main module for your application:

```javascript
// js/myapp.js
requirejs.config({
    'baseUrl': 'lib', // wq and third party libs
    'paths': {
        'myapp': '../myapp',
        'db': '../../'
    }
});
requirejs(['myapp/main']);

// js/myapp/main.js
require(['wq/app', './config', './templates'],
function(app, config, templates) {
   app.init(config, templates);
});
```

And then configuring RequireJS to load it in your `index.html`:
```xml
<script src="js/lib/require.js" data-main="js/myapp.js"></script>
```

If you are utilizing both wq.app and wq.db in your project, you may find it useful to leverage the [Django wq template] which will set up the above project layout for you.

## Advanced Configuration

WIP


## Internal API
WIP

[wq/app.js]: https://github.com/wq/wq.app/blob/master/js/wq/app.js
[wq.app]: http://wq.io/wq.app
[wq.db]: http://wq.io/wq.db
[wq/store.js]: http://wq.io/docs/store-js
[wq/pages.js]: http://wq.io/docs/pages-js
[app.py]: http://wq.io/docs/app.py
[URL structure]: http://wq.io/docs/url-structure
[shared client/server templates]: http://wq.io/docs/templates
[authentication]: http://wq.io/docs/auth
[app.router.register_model]: http://wq.io/docs/app.py
[wq.db.rest]: http://wq.io/docs/about-rest
[wq configuration object]: http://wq.io/docs/config
[My website is its own REST API]: http://wq.io/docs/website-rest-api
[client-side rendering]: http://wq.io/docs/web-app
[template rendering context]: http://wq.io/templates
[template context processors]: https://docs.djangoproject.com/en/1.6/ref/templates/api/#subclassing-context-requestcontext
[page transitions]: http://view.jquerymobile.com/1.3.2/dist/demos/widgets/transitions/
[$.mobile.defaultPageTransition]: http://view.jquerymobile.com/1.3.2/dist/demos/widgets/transitions/#Globalconfiguration
[$.mobile.defaultDialogTransition]: http://view.jquerymobile.com/1.3.2/dist/demos/widgets/transitions/#Globalconfiguration
[$.mobile.maxTransitionWidth]: http://view.jquerymobile.com/1.3.2/dist/demos/widgets/transitions/#Maxwidthfortransitions
[Mustache templates]: http://wq.io/docs/templates
[collectjson]: http://wq.io/docs/collectjson
[wq build process]: http://wq.io/docs/build
[Django wq template]: https://github.com/wq/django-wq-template
